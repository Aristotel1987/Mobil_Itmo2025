@startuml

actor Пользователь as user
participant Модуль интерфейса as app
participant Модуль управления приложением as mng
participant База Данных Температур as db
participant Датчик влажности as hsens
participant Датчик температуры as tsens
participant Устройство пользователя as device

user -> app: Активация приложения
app --> user: Запрашивает логин и пароль
user -> app: Нажимает кнопку зарегистрироваться
app -> mng: Запрашивает процедуру создания нового пользователя
mng -> app: Запрашивает логин и пароль
app -> user: Запрашивает логин и пароль нового пользователя
user -> app: Вводит новый логин

alt Неправильный логин
    app -> mng: Проверка на существование пользователя по логину
    mng -> db: Запрашивает список логинов
    mng --> mng: Проверяет, есть ли новый логин в списке
    mng --> app: Сообщает о невозможности использования такого логина
    app -> user: Запрашивает логин снова
    user -> app: Вводит логин
    app --> mng: Проверка логина
end

app --> user: Запрашивает пароль 2р
user -> app: Вводит пароль 2р

alt Недостаточно сильный пароль
    app -> user: Сообщает о недостаточной безопасности пароля 
    app -> user: Запрашивает пароль снова
    user -> app: Вводит пароль
    app --> mng: Проверка пароля
end

app --> app: Проверяет, совпадают ли пароли 

alt Несовпадающий пароль
    app -> user: Сообщает о несовпадающих паролях

    app -> user: Запрашивает пароль снова
    user -> app: Вводит логин и пароль
    app --> mng: Проверка логина и пароля
end

alt Правильный логин/пароль
    app -> mng: Создание нового пользователя
    mng -> db: Запись данных о пользователе в базу данных
    mng --> app: Успешное создание пользователя
    app -> user: Сообщает, что аккаунт создан, просит разрешить доступ к геолокации
    alt Пользователь не разрешает доступ к геолокации
        app --> user: Приложение сообщает о невозможности работы без координат помещения
        app -> user: Повторный запрос о геопозиции
    end

    mng --> device: Запрашивает данные о геолокации
    device -> mng: Передает координаты места
    mng --> db: Запись координат в базу данных
    app -> user: Запрос на добавление помещения
    user -> app: Пользователь нажимает кнопку "Добавить помещение"
    
    app -> user: Запрос id датчиков
    user -> app: Вводит id датчиков
    app -> mng: Передача id датчиков управляющему модулю
    mng -> tsens: Первичный запрос о температуре в помещении, проверка работоспособности датчика
    tsens -> mng: Данные о температуре с датчика

    alt Данные не поступают
        mng -> app: Сообщение об ошибке
        app -> user: Сообщение об ошибке, датчик не передает данные, введите id повторно
        app -> mng: Передача нового id датчика
        mng -> db: Запись нового id датчика в БД
        mng -> tsens: Повторная проверка датчика
    end

    mng -> hsens: Первичный запрос о влажности в помещении, проверка работоспособности датчика
    hsens -> mng: Данные о влажности с датчика

    alt Данные не поступают
        mng -> app: Сообщение об ошибке
        app -> user: Сообщение об ошибке, датчик не передает данные, введите id повторно
        app -> mng: Передача нового id датчика
        mng -> db: Запись id датчика влажности в БД
        mng -> hsens: Проверка датчика влажности 
    end
    mng -> app: Сообщение об успешном создании помещения
    app -> user: Аккаунт успешно создан и добавлено помещение, хотите добавить еще?
end
@enduml
